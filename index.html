<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Retro Space Run</title>
<style>
  :root{
    --bg:#060712;
    --mag:#ff3df7; /* glowing magenta */
    --cyn:#00e5ff; /* glowing cyan */
    --hud:#b6f7ff;
    --white:#e7faff;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 50% 20%, #0c0f2a 0%, #060712 60%, #03040b 100%);}
  body{font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--white); overflow:hidden;}
  #wrap{position:fixed; inset:0; display:grid; place-items:center;}
  canvas{width:100vw; height:100vh; image-rendering:pixelated; display:block; filter:contrast(1.05) saturate(1.1) drop-shadow(0 0 12px #00e5ff40);}
  /* HUD */
  #hud{
    position:fixed; left:20px; top:14px; font-weight:600; letter-spacing:.5px;
    text-shadow:0 0 6px #00e5ff88, 0 0 12px #ff3df744;
    padding:.3rem .6rem; border-radius:10px; backdrop-filter:blur(3px);
  }
  #hud .pill{display:inline-flex; align-items:center; gap:.4rem; margin-right:.6rem; padding:.15rem .7rem; border:1px solid #00e5ff66; border-radius:999px; font-size:.9rem}
  #hud .pill--level{font-size:.78rem; letter-spacing:.08em; font-weight:700; text-transform:none; white-space:nowrap; max-width:22rem; overflow:hidden; text-overflow:ellipsis;}
  #hud .hud-label{position:relative; display:inline-flex; align-items:center; font-size:.75rem; text-transform:uppercase; letter-spacing:.08em; opacity:.78; min-width:5.1rem; justify-content:flex-end;}
  #hud .hud-label::after{content:':'; margin-left:.35rem; opacity:.6; font-size:.8rem; letter-spacing:0;}
  #hud .hud-value{font-weight:700; font-variant-numeric:tabular-nums; letter-spacing:.02em;}
  #weapon{display:inline-flex; align-items:center; gap:.35rem;}
  #weapon .weapon-icon{display:inline-flex; width:1.1rem; justify-content:center; font-size:.85rem; line-height:1; color:var(--cyn); text-shadow:0 0 8px var(--mag);}
  #weapon .weapon-text{display:inline-block;}
  #hud button.pill{display:inline-flex; align-items:center; background:transparent; color:var(--white); cursor:pointer; font:inherit; text-transform:none; transition:background .2s ease, box-shadow .2s ease;}
  #hud .pill.pill--theme{gap:.6rem;}
  #hud button.pill:focus-visible{outline:2px solid var(--cyn); outline-offset:2px;}
  #hud button.pill.is-on{box-shadow:0 0 8px #00e5ff55 inset, 0 0 8px #ff3df755; background:#ffffff10;}
  #upgrade-banner{
    position:fixed; top:74px; left:50%; transform:translate(-50%,-24px);
    font-size:1rem; font-weight:700; letter-spacing:.18em; text-transform:uppercase;
    color:var(--white); text-shadow:0 0 12px #ff3df7aa, 0 0 16px #00e5ff99;
    opacity:0; pointer-events:none;
    padding:.45rem 1.2rem; border:1px solid #ffffff33; border-radius:999px;
    background:#0a0d1acc; box-shadow:0 0 18px #00e5ff33;
  }
  #upgrade-banner.is-visible{animation:upgradeFlash 1.2s ease-out forwards;}
  @keyframes upgradeFlash{
    0%{opacity:0; transform:translate(-50%,-24px) scale(.92);}
    15%{opacity:1; transform:translate(-50%,0) scale(1);}
    75%{opacity:1;}
    100%{opacity:0; transform:translate(-50%,-12px) scale(.96);}
  }
  #msg{
    position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    pointer-events:none; text-align:center;
    text-shadow:0 0 10px #ff3df7aa, 0 0 22px #00e5ffaa;
  }
  #msg .box{
    padding:18px 22px; border:1px solid #ffffff22; border-radius:14px; background:#0a0d1acc;
  }
  #msg h1{margin:.2rem 0 0.4rem; font-size:2.2rem}
  #msg p{margin:.2rem 0; opacity:.9}
  .btn,#btn{
    margin-top:.7rem; display:inline-flex; align-items:center; justify-content:center; padding:.45rem .8rem;
    border-radius:999px; cursor:pointer; text-decoration:none; pointer-events:auto; border:1px solid #00e5ffaa;
    color:var(--white); background:#ffffff0a; font-weight:600; letter-spacing:.04em;
    box-shadow:0 0 12px #00e5ff33 inset, 0 0 12px #00e5ff44; transition:background .2s ease, box-shadow .2s ease;
  }
  .btn:hover,#btn:hover{background:#00e5ff18; box-shadow:0 0 16px #00e5ff55 inset, 0 0 18px #00e5ff55;}
  .btn.btn-secondary{background:#ffffff08; border-color:#00e5ff44; box-shadow:0 0 10px #00e5ff22 inset, 0 0 10px #00e5ff22;}
  .btn.btn-secondary:hover{background:#00e5ff12;}
  .overlay-actions{display:flex; flex-wrap:wrap; gap:.75rem; justify-content:center; margin-top:1rem;}
  .level-select{margin-top:1rem; padding:.75rem; border-radius:12px; border:1px solid #00e5ff22; background:#0a0d1acc; box-shadow:0 0 12px #00e5ff11 inset;}
  .level-select[hidden]{display:none;}
  .level-select__label{margin:0 0 .6rem; text-transform:uppercase; letter-spacing:.1em; font-size:.78rem; opacity:.72;}
  .level-select__grid{display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr)); gap:.55rem;}
  .level-select__btn{padding:.45rem .65rem; border-radius:10px; border:1px solid #00e5ff44; background:#ffffff10; color:var(--white); font-weight:600; letter-spacing:.03em; cursor:pointer; transition:background .2s ease, box-shadow .2s ease;}
  .level-select__btn:hover:not([disabled]){background:#00e5ff15; box-shadow:0 0 12px #00e5ff33 inset,0 0 14px #00e5ff55;}
  .level-select__btn[disabled],.level-select__btn--locked{border-color:#ffffff22; color:#ffffff55; cursor:not-allowed; background:#ffffff08; box-shadow:none;}
  /* Scanline / vignette */
  #fx{
    position:fixed; inset:0; pointer-events:none; mix-blend-mode:screen;
    background:
      repeating-linear-gradient(0deg, #0000 0px, #0000 2px, #00e5ff05 3px, #ff3df705 4px),
      radial-gradient(1200px 700px at 50% 50%, #ffffff00 60%, #00e5ff07 70%, #00000066 100%);
  }
  .heart{color:var(--mag)}
  .cyan{color:var(--cyn)}
</style>
</head>
<body>
<div id="wrap"><canvas id="game" width="1280" height="720"></canvas></div>

<div id="hud">
  <span id="level-chip" class="pill pill--level" aria-live="polite">—</span>
  <span class="pill"><span class="hud-label">Lives</span><span id="lives" class="hud-value">3</span></span>
  <span class="pill"><span class="hud-label">Score</span><span id="score" class="hud-value">0</span></span>
  <span class="pill"><span class="hud-label">Time</span><span id="time" class="hud-value">0s</span></span>
  <span class="pill"><span class="hud-label">Weapon</span><span id="weapon" class="hud-value">None</span></span>
  <span class="pill"><span class="hud-label">Power-up</span><span id="pup" class="hud-value">None</span></span>
  <button id="assist-toggle" class="pill" type="button" aria-pressed="false">Assist: Off</button>
  <span class="pill pill--theme"><span class="hud-label">Theme</span>
    <select id="theme-select" class="hud-theme">
      <option value="synth-horizon">Synth Horizon</option>
      <option value="luminous-depths">Luminous Depths</option>
      <option value="ember-overdrive">Ember Overdrive</option>
    </select>
  </span>
</div>

<div id="upgrade-banner" aria-hidden="true"></div>

<div id="msg">
  <div class="box" id="overlay">
    <h1>RETRO <span class="cyan">SPACE</span> <span class="heart">RUN</span></h1>
    <p>WASD / Arrow keys to steer · Space to fire · P pause · F fullscreen · M mute · H Assist Mode</p>
    <p>Reach the <span class="cyan">finish gate</span> with calmer Level&nbsp;1 waves. Assist Mode adds a spare life, gentler drops, and longer invulnerability.</p>
    <a id="btn">Start</a>
  </div>
</div>

<div id="fx"></div>

<script type="module" src="./src/main.js"></script>
<script nomodule>
(() => {
// ===== Utilities =====
const lerp = (a,b,t)=>a+(b-a)*t;
const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
const rand=(a,b)=>Math.random()*(b-a)+a;
const TAU = Math.PI*2;

// ===== Canvas / DPI scale =====
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
function fitCanvas(){
  const dpr = Math.min(window.devicePixelRatio || 1, 2);
  const w = window.innerWidth, h = window.innerHeight;
  canvas.style.width = w+"px";
  canvas.style.height = h+"px";
  canvas.width = Math.floor(w*dpr);
  canvas.height = Math.floor(h*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
window.addEventListener('resize', fitCanvas);
fitCanvas();

// ===== HUD =====
const hudLives = document.getElementById('lives');
const hudScore = document.getElementById('score');
const hudTime  = document.getElementById('time');
const hudWeapon = document.getElementById('weapon');
const hudPup   = document.getElementById('pup');
const overlay  = document.getElementById('overlay');
const startBtn = document.getElementById('btn');
const themeSelect = document.getElementById('theme-select');

const THEME_STORAGE_KEY = 'retro-space-run.theme';
const DEFAULT_THEME_KEY = 'synth-horizon';
const THEMES = {
  'synth-horizon': {
    label: 'Synth Horizon',
    palette: {
      background: {
        gradient: 'radial-gradient(1200px 800px at 50% 20%, #0c0f2a 0%, #060712 60%, #03040b 100%)',
        base: '#060712',
      },
      hud: {
        text: '#e7faff',
        shadow: '#00e5ff88',
        panel: '#0a0d1acc',
        accent: '#ff3df7',
        secondary: '#00e5ff',
      },
      ship: {
        primary: '#0ae6ff',
        trim: '#ff3df7',
        cockpit: '#1efcff',
        glow: '#00e5ff88',
        trailStart: '#00e5ffcc',
        trailEnd: '#ff3df700',
        shieldInner: '#00e5ff55',
        shieldOuter: '#00e5ff00',
      },
      gate: {
        glow: '#00e5ffaa',
        fill: '#00e5ff',
        trim: '#ff3df7',
        strut: '#ff3df7',
      },
      stars: {
        bright: '#00e5ff',
        dim: '#ff3df7',
      },
      particles: {
        shieldHit: '#00e5ff',
        playerHit: '#ff3df7',
        enemyHitDefault: '#00e5ff',
        enemyHitStrafer: '#ff3df7',
        bossHit: '#ff3df7',
        bossCore: '#00e5ff',
      },
      enemies: {
        asteroidFill: '#11293b',
        asteroidStroke: '#00e5ff66',
        asteroidGlow: '#00e5ff55',
        straferFill: '#2e003b',
        straferStroke: '#ff3df7',
        straferGlow: '#ff3df799',
        droneGlowInner: '#00e5ff88',
        droneGlowOuter: '#00e5ff00',
        droneCore: '#00e5ff',
        turretFill: '#091a2c',
        turretStroke: '#00e5ff',
        turretGlow: '#00e5ff88',
        turretBarrel: '#ff3df7',
      },
      boss: {
        shadowPhase1: '#ff3df7aa',
        shadowPhase2: '#ff9dfd',
        bodyFill: '#1a0524',
        strokePhase1: '#ff3df7',
        strokePhase2: '#ffb5ff',
        canopy: '#ffdbff',
        coreGlow: '#ff3df7aa',
        coreOuter: '#ff3df700',
        beam: '#0ae6ff',
        trim: '#00e5ff',
        phase2Trim: '#ff3df7',
        introText: '#ff3df7',
        introGlow: '#ff3df788',
        healthBackground: '#060712cc',
        healthFill: '#ff3df7',
        healthShadow: '#ff3df799',
        healthStroke: '#00e5ffaa',
        healthText: '#e7faff',
      },
      bullets: {
        playerLevels: ['#ffb8ff', '#ffd6ff', '#ffeeff'],
        enemyGlow: '#00e5ffaa',
        enemyFill: '#8af5ff',
      },
      weaponToken: {
        fill: '#ff3df7',
        stroke: '#00e5ff',
        glow: '#00e5ffaa',
        text: '#00e5ff',
      },
      powerups: {
        glow: '#ffffff',
        shield: '#00e5ff',
        rapid: '#ff3df7',
        boost: '#ffffff',
      },
    },
  },
  'luminous-depths': {
    label: 'Luminous Depths',
    palette: {
      background: {
        gradient: 'radial-gradient(1200px 800px at 50% 20%, #041625 0%, #010910 60%, #000407 100%)',
        base: '#010910',
      },
      hud: {
        text: '#d9faff',
        shadow: '#24f5d988',
        panel: '#03141fcc',
        accent: '#24f5d9',
        secondary: '#1680ff',
      },
      ship: {
        primary: '#24f5d9',
        trim: '#1680ff',
        cockpit: '#9df5ff',
        glow: '#2df5d988',
        trailStart: '#24f5d9cc',
        trailEnd: '#1680ff00',
        shieldInner: '#24f5d955',
        shieldOuter: '#1680ff00',
      },
      gate: {
        glow: '#24f5d9aa',
        fill: '#24f5d9',
        trim: '#1680ff',
        strut: '#1680ff',
      },
      stars: {
        bright: '#24f5d9',
        dim: '#1680ff',
      },
      particles: {
        shieldHit: '#24f5d9',
        playerHit: '#1680ff',
        enemyHitDefault: '#24f5d9',
        enemyHitStrafer: '#1680ff',
        bossHit: '#1680ff',
        bossCore: '#24f5d9',
      },
      enemies: {
        asteroidFill: '#082839',
        asteroidStroke: '#1db0ff66',
        asteroidGlow: '#24f5d955',
        straferFill: '#021732',
        straferStroke: '#1680ff',
        straferGlow: '#1680ff99',
        droneGlowInner: '#24f5d988',
        droneGlowOuter: '#1680ff00',
        droneCore: '#24f5d9',
        turretFill: '#031e30',
        turretStroke: '#24f5d9',
        turretGlow: '#24f5d988',
        turretBarrel: '#1680ff',
      },
      boss: {
        shadowPhase1: '#1680ffaa',
        shadowPhase2: '#51c5ff',
        bodyFill: '#021524',
        strokePhase1: '#1680ff',
        strokePhase2: '#6ad5ff',
        canopy: '#c5f1ff',
        coreGlow: '#24f5d9aa',
        coreOuter: '#1680ff00',
        beam: '#24f5d9',
        trim: '#24f5d9',
        phase2Trim: '#1680ff',
        introText: '#24f5d9',
        introGlow: '#24f5d988',
        healthBackground: '#02141dcc',
        healthFill: '#1680ff',
        healthShadow: '#1680ff99',
        healthStroke: '#24f5d9aa',
        healthText: '#d9faff',
      },
      bullets: {
        playerLevels: ['#a5f6ff', '#c2fbff', '#e2ffff'],
        enemyGlow: '#24f5d9aa',
        enemyFill: '#9df5ff',
      },
      weaponToken: {
        fill: '#1680ff',
        stroke: '#24f5d9',
        glow: '#24f5d9aa',
        text: '#24f5d9',
      },
      powerups: {
        glow: '#f4ffff',
        shield: '#24f5d9',
        rapid: '#1680ff',
        boost: '#f4ffff',
      },
    },
  },
  'ember-overdrive': {
    label: 'Ember Overdrive',
    palette: {
      background: {
        gradient: 'radial-gradient(1200px 800px at 50% 20%, #2b0b00 0%, #120302 60%, #070101 100%)',
        base: '#120302',
      },
      hud: {
        text: '#ffeada',
        shadow: '#ff7b3988',
        panel: '#200804cc',
        accent: '#ff7b39',
        secondary: '#ffbd2d',
      },
      ship: {
        primary: '#ff7b39',
        trim: '#ffbd2d',
        cockpit: '#ffd9a6',
        glow: '#ff7b3988',
        trailStart: '#ff7b39cc',
        trailEnd: '#ffbd2d00',
        shieldInner: '#ff7b3955',
        shieldOuter: '#ffbd2d00',
      },
      gate: {
        glow: '#ff7b39aa',
        fill: '#ff7b39',
        trim: '#ffbd2d',
        strut: '#ffbd2d',
      },
      stars: {
        bright: '#ffbd2d',
        dim: '#ff7b39',
      },
      particles: {
        shieldHit: '#ffbd2d',
        playerHit: '#ff7b39',
        enemyHitDefault: '#ffbd2d',
        enemyHitStrafer: '#ff7b39',
        bossHit: '#ff7b39',
        bossCore: '#ffbd2d',
      },
      enemies: {
        asteroidFill: '#2f1208',
        asteroidStroke: '#ff9b3666',
        asteroidGlow: '#ff7b3955',
        straferFill: '#2b0500',
        straferStroke: '#ff7b39',
        straferGlow: '#ff7b3999',
        droneGlowInner: '#ffbd2d88',
        droneGlowOuter: '#ff7b3900',
        droneCore: '#ffbd2d',
        turretFill: '#2a0b05',
        turretStroke: '#ffbd2d',
        turretGlow: '#ffbd2d88',
        turretBarrel: '#ff7b39',
      },
      boss: {
        shadowPhase1: '#ff7b39aa',
        shadowPhase2: '#ffb37a',
        bodyFill: '#2a0400',
        strokePhase1: '#ff7b39',
        strokePhase2: '#ffbd2d',
        canopy: '#ffe6c6',
        coreGlow: '#ff7b39aa',
        coreOuter: '#ffbd2d00',
        beam: '#ffbd2d',
        trim: '#ffbd2d',
        phase2Trim: '#ff7b39',
        introText: '#ff7b39',
        introGlow: '#ff7b3988',
        healthBackground: '#1a0502cc',
        healthFill: '#ff7b39',
        healthShadow: '#ff7b3999',
        healthStroke: '#ffbd2daa',
        healthText: '#ffeada',
      },
      bullets: {
        playerLevels: ['#ffd9a6', '#ffe7c0', '#fff4da'],
        enemyGlow: '#ffbd2daa',
        enemyFill: '#ffd18c',
      },
      weaponToken: {
        fill: '#ff7b39',
        stroke: '#ffbd2d',
        glow: '#ff7b39aa',
        text: '#ffbd2d',
      },
      powerups: {
        glow: '#fff1e3',
        shield: '#ffbd2d',
        rapid: '#ff7b39',
        boost: '#fff1e3',
      },
    },
  },
};

function getThemeKeys(){
  return Object.keys(THEMES);
}

function getThemePalette(key){
  return THEMES[key]?.palette || THEMES[DEFAULT_THEME_KEY].palette;
}

function getThemeLabel(key){
  return THEMES[key]?.label || key;
}

let activeThemeKey = DEFAULT_THEME_KEY;
try {
  const stored = window.localStorage?.getItem(THEME_STORAGE_KEY);
  if (stored && THEMES[stored]) {
    activeThemeKey = stored;
  }
} catch (err) {}

let themePalette = getThemePalette(activeThemeKey);

function applyThemeToDocument(palette){
  const root = document.documentElement;
  root.style.setProperty('--mag', palette.hud.accent);
  root.style.setProperty('--cyn', palette.hud.secondary);
  root.style.setProperty('--hud', palette.hud.text);
  root.style.setProperty('--bg', palette.background.base);
  if (document.body){
    document.body.style.background = palette.background.gradient;
  }
  const hud = document.getElementById('hud');
  if (hud){
    hud.style.textShadow = `0 0 6px ${palette.hud.secondary}88, 0 0 12px ${palette.hud.accent}44`;
  }
}

function populateThemeControl(){
  if (!themeSelect) return;
  themeSelect.innerHTML = '';
  for (const key of getThemeKeys()){
    const opt = document.createElement('option');
    opt.value = key;
    opt.textContent = getThemeLabel(key);
    themeSelect.appendChild(opt);
  }
}

function syncThemeControl(){
  if (themeSelect){
    themeSelect.value = activeThemeKey;
  }
}

function setTheme(key, persist=true){
  if (!THEMES[key]) return;
  activeThemeKey = key;
  themePalette = getThemePalette(key);
  state.theme = themePalette;
  syncThemeControl();
  if (persist){
    try { window.localStorage?.setItem(THEME_STORAGE_KEY, key); } catch (err) {}
  }
  applyThemeToDocument(themePalette);
}

populateThemeControl();
applyThemeToDocument(themePalette);
syncThemeControl();

if (themeSelect){
  themeSelect.addEventListener('change', e => setTheme(e.target.value));
}

// ===== Input =====
const keys = new Set();
window.addEventListener('keydown', e=>{
  if (["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"," "].includes(e.key)) e.preventDefault();
  keys.add(e.key.toLowerCase());
});
window.addEventListener('keyup', e=> keys.delete(e.key.toLowerCase()));

// ===== Audio =====
let audioOn = true;
let ac, master;
function initAudio(){
  if (ac) return;
  ac = new (window.AudioContext||window.webkitAudioContext)();
  master = ac.createGain(); master.gain.value=0.12; master.connect(ac.destination);
}
function beep(type='square', freq=440, len=0.08, gain=0.3){
  if (!audioOn) return;
  if (!ac) initAudio();
  const o = ac.createOscillator(), g = ac.createGain();
  o.type = type; o.frequency.value = freq;
  g.gain.value = gain;
  o.connect(g); g.connect(master);
  const t = ac.currentTime;
  o.start(t);
  g.gain.exponentialRampToValueAtTime(0.0001, t+len);
  o.stop(t+len+0.02);
}
function zap(){ beep('sawtooth', 320, 0.12, 0.25); }
function pew(){ beep('square', 920, 0.06, 0.25); }
function hit(){ beep('triangle', 180, 0.2, 0.35); }
function pow(){ beep('sine', 560, 0.25, 0.28); }

// ===== Game State =====
const state = {
  running:false, paused:false,
  levelDur: 90,
  time:0, score:0, lives:3,
  player:null,
  bullets:[], enemies:[], enemyBullets:[], particles:[],
  stars:[], powerups:[], weaponDrops:[], finishGate:null,
  boss:null, bossSpawned:false, bossDefeatedAt:0,
  lastShot:0, shotDelay:180,
  speed: 260,
  scrollY: 0,
  power: {name:null, until:0},
  weapon: {name:'pulse', level:0},
  theme: themePalette,
};

// ===== Starfield =====
function spawnStars(){
  state.stars.length=0;
  const count = Math.ceil((canvas.width*canvas.height)/9000);
  for(let i=0;i<count;i++){
    state.stars.push({x:rand(0,canvas.width), y:rand(0,canvas.height), z: rand(0.4,1.6)});
  }
}
spawnStars();

// ===== Player =====
function makePlayer(){
  const p = {
    x: canvas.width/2, y: canvas.height*0.75,
    vx:0, vy:0, speed:260, r:14,
    shield:0,
    invuln:0
  };
  state.player = p;
}
makePlayer();

// ===== Entity Helpers =====
function coll(a,b, pad=0){
  const dx=a.x-b.x, dy=a.y-b.y;
  const rr = (a.r||0)+(b.r||0)+pad;
  return dx*dx+dy*dy <= rr*rr;
}
function addParticle(x,y, col, count=10, spread=2, life=400){
  for(let i=0;i<count;i++){
    state.particles.push({
      x,y, vx:rand(-spread,spread), vy:rand(-spread,spread),
      life, t:life, col
    });
  }
}

// ===== Weapons =====
const ROMAN = ['I','II','III'];
const WEAPON_DISPLAY_NAMES = Object.freeze({
  pulse: 'Pulse Cannon',
  twin: 'Twin Blaster',
  burst: 'Burst Laser',
  heavy: 'Heavy Plasma',
});
const weaponDefs = {
  pulse: {
    label: WEAPON_DISPLAY_NAMES.pulse,
    levels: [
      {
        delay: 210,
        projectiles: [
          { offsetX: 0, offsetY: -18, vx: 0, vy: -620, damage: 1, colourIndex: 0 },
        ],
      },
      {
        delay: 160,
        projectiles: [
          { offsetX: -12, offsetY: -18, vx: -110, vy: -630, damage: 1, colourIndex: 1 },
          { offsetX: 12, offsetY: -18, vx: 110, vy: -630, damage: 1, colourIndex: 1 },
        ],
      },
      {
        delay: 140,
        projectiles: [
          { offsetX: -16, offsetY: -14, vx: -180, vy: -650, damage: 1.4, colourIndex: 2 },
          { offsetX: 0, offsetY: -22, vx: 0, vy: -720, damage: 1.4, colourIndex: 2 },
          { offsetX: 16, offsetY: -14, vx: 180, vy: -650, damage: 1.4, colourIndex: 2 },
        ],
      },
    ],
  },
};
const DROP_CHANCE = 0.18;
const DROP_LIFETIME = 10000;
const BOSS_HP = 540;

function projectileColour(index=0){
  const palette = state.theme?.bullets?.playerLevels;
  const fallback = ['#ffb8ff', '#ffd6ff', '#ffeeff'];
  const colours = Array.isArray(palette) && palette.length ? palette : fallback;
  const idx = Math.max(0, Math.min(colours.length - 1, index));
  return colours[idx];
}

function weaponLabel(){
  const weapon = state.weapon;
  if (!weapon) return 'None';
  const def = weaponDefs[weapon.name];
  if (!def) return 'None';
  const levels = def.levels || [];
  const maxIndex = levels.length ? levels.length - 1 : 0;
  const levelIdx = Math.max(0, Math.min(maxIndex, weapon.level || 0));
  return `${def.label} – Level ${levelIdx + 1}`;
}

function resetWeapon(){
  state.weapon.name = 'pulse';
  state.weapon.level = 0;
  state.weaponDrops.length = 0;
  state.lastShot = 0;
  hudWeapon.textContent = weaponLabel();
}

function upgradeWeapon(name){
  const def = weaponDefs[name];
  if (!def) return;
  if (state.weapon.name !== name){
    state.weapon.name = name;
    state.weapon.level = 0;
  } else if (state.weapon.level < def.levels.length-1){
    state.weapon.level++;
  }
  state.lastShot = 0;
  hudWeapon.textContent = weaponLabel();
  pow();
}

function spawnWeaponDrop(enemy){
  if (Math.random() > DROP_CHANCE) return;
  const keys = Object.keys(weaponDefs);
  const weapon = keys[Math.floor(Math.random()*keys.length)];
  state.weaponDrops.push({
    x: enemy.x,
    y: enemy.y,
    vy: 90,
    r: 14,
    weapon,
    spin: Math.random()*Math.PI,
    t: DROP_LIFETIME,
  });
}

function updateWeaponDrops(dt){
  for (let i=state.weaponDrops.length-1;i>=0;i--){
    const drop = state.weaponDrops[i];
    drop.y += drop.vy*dt;
    drop.spin = (drop.spin||0) + dt*2.4;
    drop.t -= dt*1000;
    if (drop.t<=0 || drop.y>canvas.height+40){
      state.weaponDrops.splice(i,1);
      continue;
    }
    if (state.player && coll(state.player, drop)){
      upgradeWeapon(drop.weapon);
      state.weaponDrops.splice(i,1);
    }
  }
}

function drawWeaponDrop(drop){
  const def = weaponDefs[drop.weapon];
  const tokenPalette = state.theme?.weaponToken || {};
  const fill = tokenPalette.fill || '#ff3df7';
  const stroke = tokenPalette.stroke || '#00e5ff';
  const glow = tokenPalette.glow || `${stroke}aa`;
  const textColour = tokenPalette.text || stroke;
  ctx.save();
  ctx.translate(drop.x, drop.y);
  ctx.rotate(drop.spin||0);
  ctx.shadowColor = glow;
  ctx.shadowBlur = 12;
  ctx.fillStyle = fill;
  ctx.beginPath();
  ctx.moveTo(0,-12);
  ctx.lineTo(10,0);
  ctx.lineTo(0,12);
  ctx.lineTo(-10,0);
  ctx.closePath();
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.strokeStyle = stroke;
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.fillStyle = textColour;
  ctx.font = '10px "IBM Plex Mono", monospace';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText(def? def.label.charAt(0):'W', 0, 0);
  ctx.restore();
}

function spawnBoss(){
  state.enemies.length = 0;
  state.enemyBullets.length = 0;
  state.boss = {
    x: canvas.width/2,
    y: -160,
    vx: 0,
    vy: 160,
    r: 60,
    hp: BOSS_HP,
    maxHp: BOSS_HP,
    phase: 1,
    cooldown: 1400,
    volleyTimer: 1200,
    sweepDir: 1,
    entering: true,
    intro: 2200,
  };
}

function pushBossShot(x, y, speed, angle, radius = 8){
  state.enemyBullets.push({
    x,
    y,
    vx: Math.cos(angle) * speed,
    vy: Math.sin(angle) * speed,
    r: radius,
  });
}

function updateBoss(dt, now){
  const boss = state.boss;
  if (!boss) return;
  const particles = state.theme?.particles || {};

  if (boss.entering){
    boss.y += boss.vy * dt;
    if (boss.y >= canvas.height * 0.25){
      boss.y = canvas.height * 0.25;
      boss.vy = 0;
      boss.entering = false;
      boss.cooldown = 800;
    }
  }

  if (boss.hp <= boss.maxHp * 0.55 && boss.phase === 1){
    boss.phase = 2;
    boss.cooldown = 500;
    boss.volleyTimer = 400;
    addParticle(boss.x, boss.y, particles.bossHit || '#ff3df7', 40, 4, 800);
  }

  boss.intro = Math.max(0, (boss.intro||0) - dt*1000);

  const left = 140;
  const right = canvas.width - 140;
  const sweep = boss.phase === 1 ? 130 : 190;
  boss.x += boss.sweepDir * sweep * dt;
  if (boss.x < left){ boss.x = left; boss.sweepDir = 1; }
  else if (boss.x > right){ boss.x = right; boss.sweepDir = -1; }

  if (boss.phase === 1){
    boss.y = clamp(boss.y + Math.sin(now*0.0015) * 12 * dt * 60, canvas.height*0.22, canvas.height*0.28);
    boss.cooldown -= dt*1000;
    if (boss.cooldown <= 0){
      boss.cooldown = 900;
      const base = Math.atan2(state.player.y - boss.y, state.player.x - boss.x);
      for (let i=-1;i<=1;i++){
        const angle = base + i * 0.18;
        pushBossShot(boss.x + i*26, boss.y + 34, 260 + Math.abs(i)*20, angle);
      }
    }
  } else {
    boss.y = canvas.height*0.22 + Math.sin(now*0.0025) * 36;
    boss.cooldown -= dt*1000;
    boss.volleyTimer -= dt*1000;
    if (boss.cooldown <= 0){
      boss.cooldown = 620;
      const aim = Math.atan2(state.player.y - boss.y, state.player.x - boss.x);
      for (let i=-2;i<=2;i++){
        const angle = aim + i*0.12;
        pushBossShot(boss.x + i*22, boss.y + 28, 300 + Math.abs(i)*18, angle, 9);
      }
    }
    if (boss.volleyTimer <= 0){
      boss.volleyTimer = 2100;
      for (let i=0;i<12;i++){
        const angle = (-Math.PI/2) + (i-5.5)*0.18;
        pushBossShot(boss.x, boss.y + 12, 260 + i*6, angle, 7);
      }
    }
  }
}

function drawBoss(boss){
  if (!boss) return;
  const bossPalette = state.theme?.boss || {};
  ctx.save();
  ctx.translate(boss.x, boss.y);
  ctx.shadowColor = boss.phase===2 ? (bossPalette.shadowPhase2 || '#ff9dfd') : (bossPalette.shadowPhase1 || '#ff3df7aa');
  ctx.shadowBlur = boss.phase===2 ? 40 : 28;
  ctx.fillStyle = bossPalette.bodyFill || '#1a0524';
  ctx.strokeStyle = boss.phase===2 ? (bossPalette.strokePhase2 || '#ffb5ff') : (bossPalette.strokePhase1 || '#ff3df7');
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(-60, 20);
  ctx.quadraticCurveTo(-20, -40, 0, -50);
  ctx.quadraticCurveTo(20, -40, 60, 20);
  ctx.quadraticCurveTo(20, 40, 0, 54);
  ctx.quadraticCurveTo(-20, 40, -60, 20);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.shadowBlur = 0;
  ctx.fillStyle = bossPalette.canopy || (boss.phase===2 ? '#ffdbff' : '#ffd0ff');
  ctx.fillRect(-14, -16, 28, 32);
  drawGlowCircle(0,0,16, bossPalette.coreGlow || '#ff3df7aa', bossPalette.coreOuter || '#ff3df700');
  ctx.fillStyle = bossPalette.beam || '#0ae6ff';
  ctx.fillRect(-4,-10,8,20);
  ctx.fillStyle = bossPalette.trim || '#00e5ff';
  ctx.fillRect(-22,12,44,6);
  if (boss.phase===2){
    ctx.fillStyle = bossPalette.phase2Trim || '#ff3df7';
    ctx.fillRect(-40,24,80,6);
  }
  if (boss.intro > 0){
    ctx.save();
    ctx.translate(0,-80);
    ctx.font = '18px "Segoe UI", sans-serif';
    ctx.textAlign = 'center';
    ctx.fillStyle = bossPalette.introText || '#ff3df7';
    ctx.shadowColor = bossPalette.introGlow || '#ff3df788';
    ctx.shadowBlur = 12;
    ctx.fillText('WARNING — CORE GUARDIAN', 0,0);
    ctx.restore();
  }
  ctx.restore();
}

function drawBossHealth(){
  const boss = state.boss;
  if (!boss) return;
  const bossPalette = state.theme?.boss || {};
  const width = Math.min(canvas.width*0.5, 420);
  const x = (canvas.width - width)/2;
  const y = 42;
  const ratio = Math.max(0, boss.hp) / boss.maxHp;
  ctx.save();
  ctx.fillStyle = bossPalette.healthBackground || '#060712cc';
  ctx.fillRect(x,y,width,12);
  ctx.shadowColor = bossPalette.healthShadow || '#ff3df799';
  ctx.shadowBlur = 14;
  ctx.fillStyle = bossPalette.healthFill || '#ff3df7';
  ctx.fillRect(x,y,width*ratio,12);
  ctx.shadowBlur = 0;
  ctx.strokeStyle = bossPalette.healthStroke || '#00e5ffaa';
  ctx.lineWidth = 2;
  ctx.strokeRect(x-1,y-1,width+2,14);
  ctx.font = '14px "Segoe UI", sans-serif';
  ctx.textAlign = 'center';
  ctx.fillStyle = bossPalette.healthText || '#e7faff';
  ctx.fillText(`Boss Integrity ${Math.ceil(ratio*100)}%`, canvas.width/2, y-6);
  ctx.restore();
}

// ===== Enemies and Power-ups =====
function spawnWave(t){
  if (state.boss) return;
  const w = canvas.width;
  if (t%900<16){
    const n = 5+Math.floor(Math.random()*3);
    for(let i=0;i<n;i++){
      state.enemies.push({
        type:'asteroid', x:rand(40,w-40), y:-20-rand(0,200),
        vx:rand(-50,50), vy: rand(80,160), r:rand(12,24), hp:2
      });
    }
  }
  if (t%1400<16){
    const dir = Math.random()<0.5?-1:1;
    for(let i=0;i<3;i++){
      state.enemies.push({
        type:'strafer', x: dir<0? -30 : w+30, y: rand(60, canvas.height*0.5),
        vx: dir*rand(120,180), vy: 20*Math.sin(t*0.001+i), r:14, hp:3, cd:rand(300,700)
      });
    }
  }
  if (t%2000<16){
    for(let i=0;i<2;i++){
      state.enemies.push({
        type:'drone', x:rand(40,w-40), y:-40, vx:0, vy:rand(60,100), r:12, hp:2
      });
    }
  }
  if (t%2600<16){
    for(let i=0;i<2;i++){
      state.enemies.push({
        type:'turret', x:rand(80,w-80), y:-30, vx:0, vy:rand(70,110), r:16, hp:4, cd:600
      });
    }
  }
  if (t%12000<16){
    const kind = ['shield','rapid','boost'][Math.floor(Math.random()*3)];
    state.powerups.push({type:kind, x:rand(40,w-40), y:-30, vy:110, r:12, t:9000});
  }
}

function givePower(kind){
  const now = performance.now();
  const dur = 8000;
  state.power.name = kind;
  state.power.until = now + dur;
  hudPup.textContent = kind.toUpperCase();
  pow();
  switch(kind){
    case 'shield': state.player.shield = dur; break;
    case 'rapid' : state.lastShot = 0; break;
    case 'boost' : state.player.speed = 360; break;
  }
}
function clearExpiredPowers(now){
  if (state.power.name && now > state.power.until){
    if (state.power.name==='boost') state.player.speed = 260;
    state.power.name = null; hudPup.textContent = 'None';
    state.player.shield = 0;
  }
}

// ===== Finish Gate =====
function ensureFinishGate(){
  if (state.finishGate) return;
  state.finishGate = {
    x: canvas.width/2, y: -200, vy: 80, w: 240, h: 12, glow:0
  };
}

// ===== Game Flow =====
function start(){
  state.running = true; state.paused=false;
  state.time=0; state.score=0; state.lives=3;
  state.bullets.length=0; state.enemies.length=0; state.enemyBullets.length=0;
  state.powerups.length=0; state.weaponDrops.length=0; state.particles.length=0; state.finishGate=null;
  state.boss=null; state.bossSpawned=false; state.bossDefeatedAt=0;
  state.theme = themePalette;
  spawnStars(); makePlayer(); resetWeapon();
  hudLives.textContent = state.lives;
  hudScore.textContent = state.score;
  hudTime.textContent  = '0s';
  hudPup.textContent   = 'None';
  overlay.style.display='none';
  lastFrame = performance.now();
  requestAnimationFrame(loop);
}
function gameOver(win=false){
  state.running=false;
  overlay.style.display='block';
  overlay.innerHTML = `
    <h1>${win?'<span class="cyan">MISSION COMPLETE</span>':'<span class="heart">GAME OVER</span>'}</h1>
    <p>Score: <strong>${state.score}</strong> · Time: <strong>${Math.floor(state.time)}</strong>s</p>
    <p>${win?'You reached the finish gate.':'You lost all lives.'} Press Start to try again.</p>
    <a id="btn">Start</a>`;
  document.getElementById('btn').onclick = start;
}

// ===== Rendering bits =====
function drawGlowCircle(x,y,r, c1, c2){
  const g = ctx.createRadialGradient(x,y, r*0.2, x,y, r*1.6);
  g.addColorStop(0, c1);
  g.addColorStop(1, c2);
  ctx.fillStyle=g; ctx.beginPath(); ctx.arc(x,y,r,0,TAU); ctx.fill();
}
function drawShip(p){
  const ship = state.theme?.ship || {};
  ctx.save();
  ctx.translate(p.x, p.y);
  const tilt = clamp((keys.has('arrowleft')||keys.has('a')?-1:0)+(keys.has('arrowright')||keys.has('d')?1:0), -1, 1);
  ctx.rotate(tilt*0.08);
  const engLen = 14 + (Math.sin(performance.now()*0.02)+1)*6;
  const trail = ctx.createLinearGradient(0,0,0,30);
  trail.addColorStop(0, ship.trailStart || '#00e5ffcc');
  trail.addColorStop(1, ship.trailEnd || '#ff3df700');
  ctx.fillStyle=trail;
  ctx.beginPath(); ctx.moveTo(0,10); ctx.lineTo(-6,24+engLen); ctx.lineTo(6,24+engLen); ctx.closePath(); ctx.fill();
  ctx.shadowColor=ship.glow || '#00e5ff88'; ctx.shadowBlur=12;
  ctx.fillStyle=ship.primary || '#0ae6ff'; ctx.strokeStyle=ship.trim || '#ff3df7';
  ctx.lineWidth=1.6;
  ctx.beginPath();
  ctx.moveTo(0,-16); ctx.lineTo(12,10); ctx.lineTo(0,16); ctx.lineTo(-12,10); ctx.closePath();
  ctx.fill(); ctx.stroke();
  ctx.shadowBlur=0;
  ctx.fillStyle=ship.cockpit || '#1efcff';
  ctx.beginPath(); ctx.ellipse(0,-6,5,7,0,0,TAU); ctx.fill();
  if (p.shield>0){
    ctx.globalAlpha = 0.6 + 0.4*Math.sin(performance.now()*0.01);
    drawGlowCircle(0,0,p.r+6, ship.shieldInner || '#00e5ff55', ship.shieldOuter || '#00e5ff00');
  }
  ctx.restore();
}
function drawBullet(b){
  ctx.save();
  ctx.translate(b.x,b.y);
  const col = b.colour || '#ffb8ff';
  ctx.shadowColor=col+'aa'; ctx.shadowBlur=10;
  ctx.fillStyle=col;
  ctx.fillRect(-2,-6,4,12);
  ctx.restore();
}
function drawEnemy(e){
  const enemyPalette = state.theme?.enemies || {};
  ctx.save(); ctx.translate(e.x,e.y);
  if (e.type==='asteroid'){
    ctx.shadowColor=enemyPalette.asteroidGlow || '#00e5ff55'; ctx.shadowBlur=6;
    ctx.fillStyle=enemyPalette.asteroidFill || '#11293b'; ctx.strokeStyle=enemyPalette.asteroidStroke || '#00e5ff66'; ctx.lineWidth=1;
    ctx.beginPath(); for(let i=0;i<7;i++){ const ang=i/7*TAU, rr=e.r+rand(-4,4); ctx.lineTo(Math.cos(ang)*rr, Math.sin(ang)*rr); } ctx.closePath();
    ctx.fill(); ctx.stroke();
  } else if (e.type==='strafer'){
    ctx.shadowColor=enemyPalette.straferGlow || '#ff3df799'; ctx.shadowBlur=10;
    ctx.fillStyle=enemyPalette.straferFill || '#2e003b'; ctx.strokeStyle=enemyPalette.straferStroke || '#ff3df7'; ctx.lineWidth=1.5;
    ctx.beginPath(); ctx.moveTo(-14,0); ctx.lineTo(0,-10); ctx.lineTo(14,0); ctx.lineTo(0,10); ctx.closePath(); ctx.fill(); ctx.stroke();
  } else if (e.type==='drone'){
    ctx.shadowColor=enemyPalette.droneGlowInner || '#00e5ffaa'; ctx.shadowBlur=12;
    drawGlowCircle(0,0,e.r, enemyPalette.droneGlowInner || '#00e5ff88', enemyPalette.droneGlowOuter || '#00e5ff00');
    ctx.fillStyle=enemyPalette.droneCore || '#00e5ff'; ctx.fillRect(-2,-2,4,4);
  } else if (e.type==='turret'){
    ctx.shadowColor=enemyPalette.turretGlow || '#00e5ff88'; ctx.shadowBlur=12;
    ctx.fillStyle=enemyPalette.turretFill || '#091a2c'; ctx.strokeStyle=enemyPalette.turretStroke || '#00e5ff'; ctx.lineWidth=1.8;
    ctx.beginPath(); ctx.arc(0,0,12,0,TAU); ctx.fill(); ctx.stroke();
    ctx.fillStyle=enemyPalette.turretBarrel || '#ff3df7'; ctx.fillRect(-2,-8,4,8);
  }
  ctx.restore();
}
function drawEnemyBullet(b){
  const bulletPalette = state.theme?.bullets || {};
  ctx.save(); ctx.translate(b.x,b.y);
  ctx.shadowColor=bulletPalette.enemyGlow || '#00e5ffaa'; ctx.shadowBlur=8;
  ctx.fillStyle=bulletPalette.enemyFill || '#8af5ff'; ctx.fillRect(-2,-5,4,9);
  ctx.restore();
}
function drawPowerUp(p){
  const powerPalette = state.theme?.powerups || {};
  ctx.save(); ctx.translate(p.x,p.y);
  ctx.shadowColor=powerPalette.glow || '#fff'; ctx.shadowBlur=10;
  if (p.type==='shield'){
    ctx.strokeStyle=powerPalette.shield || '#00e5ff'; ctx.lineWidth=2; ctx.beginPath(); ctx.arc(0,0,10,0,TAU); ctx.stroke();
  } else if (p.type==='rapid'){
    ctx.strokeStyle=powerPalette.rapid || '#ff3df7'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-8,-6); ctx.lineTo(8,6); ctx.moveTo(-8,6); ctx.lineTo(8,-6); ctx.stroke();
  } else if (p.type==='boost'){
    ctx.strokeStyle=powerPalette.boost || '#ffffff'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(0,-10); ctx.lineTo(-6,8); ctx.lineTo(6,8); ctx.closePath(); ctx.stroke();
  }
  ctx.restore();
}
function drawGate(g){
  const gatePalette = state.theme?.gate || {};
  ctx.save(); ctx.translate(g.x, g.y);
  const w=g.w, h=g.h;
  const glow = (Math.sin(performance.now()*0.003)+1)*0.5;
  ctx.shadowColor=gatePalette.glow || '#00e5ffaa'; ctx.shadowBlur=20+20*glow;
  ctx.fillStyle=gatePalette.fill || '#00e5ff';
  ctx.fillRect(-w/2,-h/2,w,h);
  ctx.shadowBlur=0;
  ctx.strokeStyle=gatePalette.strut || gatePalette.trim || '#ff3df7'; ctx.lineWidth=3;
  ctx.beginPath();
  ctx.moveTo(-w/2, -40); ctx.lineTo(-w/2, 40);
  ctx.moveTo(w/2, -40); ctx.lineTo(w/2, 40);
  ctx.stroke();
  ctx.restore();
}

// ===== Loop =====
let lastFrame = 0;
function loop(now){
  if (!state.running){ return; }
  const dt = (now - lastFrame)/1000; lastFrame = now;
  if (state.paused){ requestAnimationFrame(loop); return; }

  state.time += dt;
  hudTime.textContent = `${Math.floor(state.time)}s`;
  if (state.time>=state.levelDur){
    if (!state.bossSpawned){
      spawnBoss();
      state.bossSpawned = true;
    } else if (!state.boss && !state.finishGate && now - state.bossDefeatedAt > 600){
      ensureFinishGate();
    }
  }

  ctx.clearRect(0,0,canvas.width,canvas.height);
  for (const s of state.stars){
    s.y += (60*s.z + state.speed*0.05* s.z) * dt;
    if (s.y>canvas.height){ s.y = -2; s.x = rand(0,canvas.width); }
    ctx.globalAlpha = 0.4*s.z;
    const starPalette = state.theme?.stars || {};
    ctx.fillStyle = s.z>1.1 ? (starPalette.bright || '#00e5ff') : (starPalette.dim || '#ff3df7');
    ctx.fillRect(s.x, s.y, 2,2);
  }
  ctx.globalAlpha = 1;
  const particles = state.theme?.particles || {};

  const p = state.player;
  const accel = (state.power.name==='boost')? 560: 380;
  const up   = keys.has('arrowup')||keys.has('w');
  const down = keys.has('arrowdown')||keys.has('s');
  const left = keys.has('arrowleft')||keys.has('a');
  const right= keys.has('arrowright')||keys.has('d');
  const ax = (left?-accel:0) + (right?accel:0);
  const ay = (up?-accel*0.8:0) + (down?accel*0.8:0);
  p.vx = lerp(p.vx, ax, 0.08);
  p.vy = lerp(p.vy, ay, 0.08);
  p.x += p.vx*dt; p.y += p.vy*dt;
  p.x = clamp(p.x, 20, canvas.width-20);
  p.y = clamp(p.y, 40, canvas.height-40);

  const weaponDef = weaponDefs[state.weapon.name] || weaponDefs.pulse;
  const levelIdx = Math.min(state.weapon.level, weaponDef.levels.length-1);
  const weaponLevel = weaponDef.levels[levelIdx];
  const delay = Math.max(70, weaponLevel.delay * (state.power.name==='rapid'?0.6:1));
  if ((keys.has(' ') || keys.has('space')) && now - state.lastShot > delay){
    state.lastShot = now;
    for (const proj of weaponLevel.projectiles){
      state.bullets.push({
        x: p.x + proj.offsetX,
        y: p.y + proj.offsetY,
        vx: proj.vx,
        vy: proj.vy,
        r: 6,
        damage: proj.damage,
        colour: projectileColour(proj.colourIndex || 0),
        life: 1200,
      });
    }
    pew();
  }

  for (let i=state.bullets.length-1;i>=0;i--){
    const b = state.bullets[i];
    b.x += (b.vx||0)*dt;
    b.y += b.vy*dt;
    b.life = (b.life||0) - dt*1000;
    if (b.y<-40 || b.y>canvas.height+40 || b.x<-40 || b.x>canvas.width+40 || b.life<=0){
      state.bullets.splice(i,1);
    }
  }

  spawnWave(now);
  updateBoss(dt, now);

  for (let i=state.enemies.length-1;i>=0;i--){
    const e = state.enemies[i];
    if (e.type==='asteroid'){
      e.x+=e.vx*dt; e.y+=e.vy*dt;
      if (e.x<-40||e.x>canvas.width+40) e.vx*=-1;
    } else if (e.type==='strafer'){
      e.x+=e.vx*dt; e.y+=Math.sin(now*0.004+i)*40*dt;
      e.cd-=dt*1000;
      if (e.cd<=0){
        e.cd=rand(600,1100);
        state.enemyBullets.push({x:e.x, y:e.y+10, vx: (p.x-e.x)*0.0025, vy: 180, r:6});
      }
      if (e.x<-60||e.x>canvas.width+60){ state.enemies.splice(i,1); continue; }
    } else if (e.type==='drone'){
      const dx=p.x-e.x, dy=p.y-e.y, d=Math.hypot(dx,dy)+0.0001;
      e.vx += (dx/d)*60*dt; e.vy += (dy/d)*60*dt;
      e.x+=e.vx*dt; e.y+=e.vy*dt;
    } else if (e.type==='turret'){
      e.y+=e.vy*dt;
      e.cd-=dt*1000;
      if (e.cd<=0){
        e.cd=600+Math.random()*600;
        const angle = Math.atan2(p.y-e.y, p.x-e.x);
        state.enemyBullets.push({x:e.x, y:e.y, vx: Math.cos(angle)*220, vy: Math.sin(angle)*220, r:6});
      }
    }
    if (e.y>canvas.height+80) { state.enemies.splice(i,1); continue; }
  }

  for (let i=state.enemyBullets.length-1;i>=0;i--){
    const b = state.enemyBullets[i];
    b.x += (b.vx||0)*dt;
    b.y += b.vy*dt;
    if (b.y<-40||b.y>canvas.height+40||b.x<-40||b.x>canvas.width+40) state.enemyBullets.splice(i,1);
  }

  for (let i=state.powerups.length-1;i>=0;i--){
    const pu = state.powerups[i];
    pu.y += pu.vy*dt;
    pu.t -= dt*1000;
    if (pu.t<=0 || pu.y>canvas.height+30) { state.powerups.splice(i,1); continue; }
    if (coll(p, pu)){
      givePower(pu.type);
      state.powerups.splice(i,1);
    }
  }
  updateWeaponDrops(dt);
  clearExpiredPowers(now);

  if (state.finishGate){
    const g = state.finishGate;
    g.y += g.vy*dt;
    if (g.y > canvas.height*0.25) g.vy = 0;
    if (Math.abs(p.y - g.y) < 28 && Math.abs(p.x - g.x) < g.w/2){
      zap(); zap(); pow();
      gameOver(true); return;
    }
  }

  for (let i=state.enemies.length-1;i>=0;i--){
    const e = state.enemies[i];
    for (let j=state.bullets.length-1;j>=0;j--){
      const b = state.bullets[j];
      if (coll(e,b, -4)){
        state.bullets.splice(j,1);
        e.hp -= b.damage || 1;
        const enemyCol = e.type==='strafer' ? (particles.enemyHitStrafer || '#ff3df7') : (particles.enemyHitDefault || '#00e5ff');
        addParticle(e.x,e.y, enemyCol, 12, 2.6, 300);
        if (e.hp<=0){
          state.enemies.splice(i,1);
          state.score += 25;
          hudScore.textContent = state.score;
          hit();
          spawnWeaponDrop(e);
        }
        break;
      }
    }
  }

  if (state.boss){
    for (let j=state.bullets.length-1;j>=0;j--){
      const b = state.bullets[j];
      if (coll(state.boss, b, -12)){
        state.bullets.splice(j,1);
        state.boss.hp -= b.damage || 1;
        addParticle(state.boss.x, state.boss.y, particles.bossHit || '#ff3df7',18,3.4,320);
        hit();
        if (state.boss.hp<=0){
          addParticle(state.boss.x, state.boss.y, particles.bossHit || '#ff3df7',60,5,1000);
          addParticle(state.boss.x, state.boss.y, particles.bossCore || '#00e5ff',40,4,1000);
          pow();
          state.score += 600;
          hudScore.textContent = state.score;
          const dropOrigin = {x: state.boss.x, y: state.boss.y};
          spawnWeaponDrop(dropOrigin);
          state.boss = null;
          state.bossDefeatedAt = now;
        }
        break;
      }
    }
  }

  function playerHit(){
    if (p.shield>0){ p.shield-=400; addParticle(p.x,p.y,particles.shieldHit || '#00e5ff',20,3,400); hit(); return; }
    if (p.invuln>0) return;
    state.lives--; hudLives.textContent = state.lives;
    addParticle(p.x,p.y,particles.playerHit || '#ff3df7',30,3.2,500); zap();
    p.invuln = 2000;
    if (state.lives<=0){ gameOver(false); }
  }
  for (const e of state.enemies){
    if (coll(p, e, -4)) playerHit();
  }
  if (state.boss && coll(p, state.boss, -26)) playerHit();
  for (const b of state.enemyBullets){
    if (coll(p,b, -2)) playerHit();
  }
  if (p.invuln>0) p.invuln -= dt*1000;

  for (const drop of state.weaponDrops) drawWeaponDrop(drop);
  for (const pu of state.powerups) drawPowerUp(pu);
  for (const e of state.enemies) drawEnemy(e);
  if (state.boss) drawBoss(state.boss);
  for (const b of state.enemyBullets) drawEnemyBullet(b);
  for (const b of state.bullets) drawBullet(b);
  if (state.finishGate) drawGate(state.finishGate);
  drawShip(p);
  if (state.boss) drawBossHealth();

  for (let i=state.particles.length-1;i>=0;i--){
    const q = state.particles[i];
    q.t -= dt*1000; q.x += q.vx; q.y += q.vy;
    if (q.t<=0){ state.particles.splice(i,1); continue; }
    ctx.globalAlpha = q.t/q.life;
    ctx.fillStyle = q.col; ctx.fillRect(q.x,q.y,2,2);
    ctx.globalAlpha = 1;
  }

  state.score += Math.floor(30*dt);
  hudScore.textContent = state.score;

  requestAnimationFrame(loop);
}

// ===== Controls =====
document.addEventListener('keydown', e=>{
  if (!state.running) return;
  if (e.key.toLowerCase()==='p'){
    state.paused=!state.paused;
    overlay.style.display = state.paused?'block':'none';
    overlay.innerHTML = `<h1>${state.paused?'PAUSED':''}</h1><p>${state.paused?'Press P to resume':''}</p>`;
  } else if (e.key.toLowerCase()==='m'){
    audioOn = !audioOn;
    if (audioOn) initAudio(), pow();
  } else if (e.key.toLowerCase()==='f'){
    const el = document.documentElement;
    if (!document.fullscreenElement) el.requestFullscreen?.();
    else document.exitFullscreen?.();
  }
});

startBtn.onclick = start;
window.addEventListener('click', ()=>{ if (ac && ac.state==='suspended') ac.resume(); }, {once:false});
})();
</script>
</body>
</html>
